# Chapter 11: Replication and Consistency

## Fault Tolerance

- Fault tolerance is a property of a system that can continue operating correctly in the presence of failures
- Making a system fault tolerant is not an easy task, and it may be difficult to add fault tolerance to an existing system
- The primary goal is to remove single points of failure from the system
- Usually achieved by ensuring that if one machine fails, others can continue operating correctly

## Data Replication

- Updating multiple copies can be quite costly to perform for every operation
- Systems often explore tradeoffs while allowing some degree of availability
- Availability means being able to respond to every request

## CAP Theorem

- Consistency is defined here as atomic or linearizable consistency
  - Linearizable history can be expressed as a sequence of instantaneous operations
- Availability requires any non-failing node to respond
- CAP describes a fundamental tradeoff:
  - CA: Consistent and Available (but not Partition tolerant)
  - CP: Consistent and Partition tolerant (may fail requests)
  - AP: Available and Partition tolerant (loosens consistency requirements)
- Partition tolerance is a property we cannot realistically tune or trade with in distributed systems

## Ordering in Distributed Systems

- It's hard to know when exactly something has happened in a distributed system
- Events are not available instantly across the cluster
- Each participant may have its own view of the state
- We have to look at every operation in terms of its invocation and completion events

## Consistency Models

- Consistency models serve as a contract between participants
- They define what each replica has to do to satisfy required semantics
- They establish what users can expect when issuing read and write operations
- Without a global clock, it's difficult to give distributed operations a precise and deterministic order
  - It's like a "special relativity theory for data"

### Types of Consistency Models:

1. **Strict Consistency**

   - Equivalent of complete replication transparency
   - Any write by any process is instantly available to all users
   - A theoretical model impossible to implement due to physical limitations

2. **Linearizability**

   - The strongest single-object consistency model
   - Effects of writes become visible to all readers between the operation's start and end
   - There is some flexibility in ordering, but operations cannot be reordered

3. **Sequential Consistency**

   - Operations of each individual process are executed in the same order they were performed
   - Processes can observe operations executed by other participants in order consistent with their own history
   - Views can be arbitrarily stale from the global perspective

4. **Causal Consistency**

   - All processes have to see causally related operations in the same order
   - Concurrent writes with no causal relationship can be observed in different orders by different processors

5. **Session Models (Client-Centric Consistency)**

   - Help reason about the state of the distributed system from the client perspective
   - Focus on how each client observes the system state while issuing read and write operations
   - If a client crashes or loses connection before an operation completes, no assumptions are made about incomplete operations

6. **Eventual Consistency**
   - Updates propagate through the system asynchronously
   - If no additional updates are performed against a data item, eventually all accesses return the last written value
   - In case of conflicts, the notion of "last/latest value" might change as values from diverse replicas are reconciled
   - Conflict resolution strategies include "last write wins" or using vector clocks
   - "Eventually" specifies no hard time bound for propagation
   - Despite theoretical concerns, this model works well in practice, and many modern databases are described as "eventually consistent"

# 第11章: レプリケーションと一貫性

## 耐障害性

- 耐障害性とは、システムの障害が発生してもシステムが正常に動作し続けることができる特性です
- 耐障害性のあるシステムを構築することは簡単ではなく、既存のシステムに耐障害性を追加することは難しい場合があります
- 主な目標は、システムから単一障害点を取り除くことです
- 通常、あるマシンが故障しても、他のマシンが正常に動作し続けられるよ���にすることで実現します

## データレプリケーション

- 複数のコピーを更新することは、すべての操作に対して実行するとコストがかかる場合があります
- システムは多くの場合、可用性のある程度を許容しながらトレードオフを探ります
- 可用性とは、すべてのリクエストに応答できることを意味します

## CAPの定理

- ここでの一貫性は、アトミックまたは線形化可能な一貫性として定義されています
  - 線形化可能な履歴は、瞬時の操作のシーケンスとして表現できます
- 可用性は、障害のないノードが応答できることを要求します
- CAPは基本的なトレードオフを説明します：
  - CA: 一貫性があり可用性がある（ただしパーティション耐性はない）
  - CP: 一貫性があり、パーティション耐性がある（リクエストが失敗する可能性あり）
  - AP: 可用性があり、パーティション耐性がある（一貫性要件を緩和）
- パーティション耐性は、分散システムでは現実的に調整したり交換したりできない特性です

## 分散システムにおける順序付け

- 分散システムでは、何かが正確にいつ起こったのかを知ることが難しいです
- イベントはクラスター全体で即座に利用可能になるわけではありません
- 各参加者は自分自身の状態のビューを持っている可能性があります
- すべての操作を、その呼び出しと完了のイベントの観点から見る必要があります

## 一貫性モデル

- 一貫性モデルは参加者間の契約として機能します
- 各レプリカが必要なセマンティクスを満たすために何をすべきかを定義します
- ユーザーが読み書き操作を発行するときに期待できることを確立します
- グローバルクロックがなければ、分散操作に正確で決定論的な順序を与えることは困難です
  - これは「データに対する特殊相対性理論」のようなものです

### 一貫性モデルの種類：

1. **厳密な一貫性**

   - 完全なレプリケーションの透明性に相当します
   - どのプロセスによる書き込みも、すべてのユーザーに即座に利用可能になります
   - 物理的な制限により実装不可能な理論モデルです

2. **線形化可能性**

   - 最も強力な単一オブジェクトの一貫性モデル
   - 書き込みの効果は、操作の開始と終了の間にすべての読者に見えるようになります
   - 順序付けにはある程度の柔軟性がありますが、操作を並べ替えることはできません

3. **逐次一貫性**

   - 各個別プロセスの操作は、実行された順序と同じ順序で実行されます
   - プロセスは、他の参加者によって実行された操作を、自分自身の履歴と一致する順序で観察できます
   - グローバルな視点からは、ビューは任意に古くなる可能性があります

4. **因果一貫性**

   - すべてのプロセスは、因果関係のある操作を同じ順序で見る必要があります
   - 因果関係のない並行書き込みは、異なるプロセッサによって異なる順序で観察される可能性があります

5. **セッションモデル（クライアント中心の一貫性）**

   - クライアントの視点から分散システムの状態を推論するのに役立ちます
   - 各クライアントが読み書き操作を発行しながらシステムの状態をどのように観察するかに焦点を当てます
   - クライアントが操作完了前にクラッシュまたは接続を失った場合、未完了の操作の状態について仮定はしません

6. **結果整合性**
   - 更新はシステム全体に非同期的に伝播します
   - データ項目に対して追加の更新が実行されない場合、最終的にすべてのアクセスは最後に書き込まれた値を返します
   - 競合が発生した場合、多様なレプリカからの値が調整されるにつれて、「最後/最新の値」の概念は変わる可能性があります
   - 競合解決戦略には「最後の書き込みが優先」やベクトルクロックの使用などがあります
   - 「最終的に」という表現は、伝播のための厳密な時間制限を指定していません
   - 理論的な懸念にもかかわらず、このモデルは実際にはうまく機能しており、現代の多くのデータベースは「結果整合性」があると説明されています
